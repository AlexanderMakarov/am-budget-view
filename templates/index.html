<!DOCTYPE html>
<html lang="{{.Locale}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AM Budget View</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="/static/outer/echarts@5.5.1.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>AM Budget View</h1>
            <div class="header-right">
                <select id="timelineSelector" class="inheader-selector">
                    <option value="all">{{localize "All time"}}</option>
                    <option value="24">{{localize "2 years"}}</option>
                    <option value="12" selected="selected">{{localize "1 year"}}</option>
                    <option value="6">{{localize "6 months"}}</option>
                    <option value="3">{{localize "3 months"}}</option>
                </select>
                <select id="localeSelector" class="inheader-selector">
                    <option value="en-US" {{if eq .Locale "en-US"}}selected="selected"{{end}}>English</option>
                    <option value="ru-RU" {{if eq .Locale "ru-RU"}}selected="selected"{{end}}>Русский</option>
                </select>
                <select id="currencySelector" class="inheader-selector">
                    {{range .Currencies}}
                        <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
                <button onclick="window.location.href='/files'" class="primary-button">
                    {{localize "Files"}}
                </button>
                <button onclick="window.location.href='/categorization'" class="primary-button">
                    {{localize "Transaction Categorization"}}
                </button>
                <a href="https://github.com/AlexanderMakarov/am-budget-view" target="_blank" class="github-link">{{localize "Details on GitHub"}}</a>
            </div>
        </header>
        <div id="expensesVsIncome" class="chart"></div>
        <div class="chart-row">
            <div id="totalExpenses" class="chart"></div>
            <div id="totalIncome" class="chart"></div>
        </div>
        <h3 class="clickable-note">
            {{localize "note_bars_clickable"}}
        </h3>
        <div id="monthlyExpenses" class="chart"></div>
        <div id="monthlyIncome" class="chart"></div>
        <div class="explanation-text">
            {{localize "Notes"}}
            <ul>
                <li>{{localize "note_exchange_rates"}}</li>
                <li>{{localize "note_unknown_transactions"}}</li>
            </ul>
        </div>
    </div>
    <script id="interval-statistics" type="application/json">
        {{.Statistics}}
    </script>
    <script>
        // Pass localized strings to JavaScript
        window.localizedStrings = {
            expensesVsIncome: "{{localize "Expenses vs Income"}}",
            expenses: "{{localize "Expenses"}}",
            incomes: "{{localize "Incomes"}}",
            totalExpensesPerCategory: "{{localize "Total Expenses per Category"}}",
            totalIncomePerCategory: "{{localize "Total Income per Category"}}",
            amount: "{{localize "Amount"}}",
            monthlyExpensesPerCategory: "{{localize "Monthly Expenses per Category (%)"}}",
            monthlyIncomePerCategory: "{{localize "Monthly Income per Category (%)"}}",
            percentage: "{{localize "Percentage"}}"
        };
    </script>
    <script>
        function formatCurrency(value) {
            return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        document.addEventListener("DOMContentLoaded", function () {
            const data = JSON.parse(document.getElementById("interval-statistics").textContent);
            console.log(data);
            const currencySelector = document.getElementById("currencySelector");
            const timelineSelector = document.getElementById("timelineSelector");
            let currentCurrency = currencySelector.value;
            const localeSelector = document.getElementById("localeSelector");
            if (!localeSelector) {
                console.error("Locale selector not found!");
                return;
            }
            console.log("Current locale from server:", localeSelector.value);
            localeSelector.addEventListener("change", function (event) {
                const newLocale = this.value;
                console.log("Locale changed to:", newLocale);
                const url = new URL(window.location.href);
                url.searchParams.set("locale", newLocale);
                const newUrl = url.toString();
                console.log("Redirecting to:", newUrl);
                window.location.replace(newUrl);
            });
            function sliceByTimeline(array, monthsValue) {
                if (!monthsValue || monthsValue === "all") return array;
                const months = parseInt(monthsValue, 10);
                if (Number.isNaN(months)) return array;
                return array.slice(-months);
            }
            function updateCharts(currency) {
                const monthsValue = timelineSelector ? timelineSelector.value : "all";
                const currencyDataFull = data.map((stat) => stat[currency]);
                const currencyData = sliceByTimeline(currencyDataFull, monthsValue);
                const labels = currencyData.map((stat) => stat.Start.substring(0, 7));
                const incomeData = [];
                const expenseData = [];
                const incomeGroups = new Set();
                const expenseGroups = new Set();
                function parseMoneyString(str) {
                    return parseFloat(str.replace(/\s/g, ""));
                }
                currencyData.forEach((stat) => {
                    let totalIncome = 0;
                    let totalExpense = 0;
                    Object.entries(stat.Income).forEach(([group, data]) => {
                        totalIncome += parseMoneyString(data.Total);
                        incomeGroups.add(group);
                    });
                    Object.entries(stat.Expense).forEach(([group, data]) => {
                        totalExpense += parseMoneyString(data.Total);
                        expenseGroups.add(group);
                    });
                    incomeData.push(Number(totalIncome.toFixed(2)));
                    expenseData.push(Number(totalExpense.toFixed(2)));
                });
                const expensesVsIncome = echarts.init(document.getElementById("expensesVsIncome"));
                const expensesVsIncomeOption = {
                    title: { text: window.localizedStrings.expensesVsIncome },
                    tooltip: { trigger: "axis", axisPointer: { type: "cross", label: { backgroundColor: "#6a7985" } } },
                    legend: { data: [window.localizedStrings.expenses, window.localizedStrings.incomes] },
                    toolbox: { feature: {
                        saveAsImage: {show: true, pixelRatio: 2, title: "Save as x2 image"},
                        magicType: { type: ["line", "bar"] },
                        dataView: {show: true, readOnly: true} }
                    },
                    xAxis: { type: "category", data: labels },
                    yAxis: { type: "value" },
                    series: [
                        { name: window.localizedStrings.expenses, color: "red", type: "line", data: expenseData },
                        { name: window.localizedStrings.incomes, color: "blue", type: "line", data: incomeData },
                    ],
                };
                expensesVsIncome.setOption(expensesVsIncomeOption);
                const totalExpenses = echarts.init(document.getElementById("totalExpenses"));
                const totalExpensesOption = {
                    title: { text: window.localizedStrings.totalExpensesPerCategory },
                    tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
                    legend: { show: false },
                    toolbox: { show: true, feature: {
                        saveAsImage: {show: true, pixelRatio: 3, title: "Save as x3 image"},
                        dataView: {show: true, readOnly: true}
                    } },
                    grid: { left: "3%", right: "4%", bottom: "10%", top: "40px", containLabel: true },
                    xAxis: { type: "value", name: window.localizedStrings.amount, nameLocation: "middle", nameGap: 30, nameRotate: 0, nameTextStyle: { padding: [10, 0, 0, 0] } },
                    yAxis: { type: "category", data: Array.from(expenseGroups), interval: 0 },
                    series: [
                        {
                            name: window.localizedStrings.expenses,
                            color: "red",
                            type: "bar",
                            data: Array.from(expenseGroups).map((group) => ({
                                value: currencyData.reduce(
                                    (sum, stat) => Number((sum + parseMoneyString(stat.Expense[group]?.Total || "0")).toFixed(2)),
                                    0
                                ),
                                name: group,
                            })),
                        },
                    ],
                };
                const chartHeight = Math.max(400, Math.max(expenseGroups.size, incomeGroups.size) * 20 + 100);
                const totalExpensesEl = document.getElementById("totalExpenses");
                totalExpensesEl.style.height = chartHeight + "px";
                totalExpenses.setOption(totalExpensesOption);
                totalExpenses.resize();
                const totalIncome = echarts.init(document.getElementById("totalIncome"));
                const totalIncomeOption = {
                    title: { text: window.localizedStrings.totalIncomePerCategory },
                    tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
                    legend: { show: false },
                    toolbox: { show: true, feature: {
                        saveAsImage: {show: true, pixelRatio: 3, title: "Save as x3 image"},
                        dataView: {show: true, readOnly: true}
                    } },
                    grid: { left: "3%", right: "4%", bottom: "10%", top: "40px", containLabel: true },
                    xAxis: { type: "value", name: window.localizedStrings.amount, nameLocation: "middle", nameGap: 30, nameRotate: 0, nameTextStyle: { padding: [10, 0, 0, 0] } },
                    yAxis: { type: "category", data: Array.from(incomeGroups), interval: 0 },
                    series: [
                        {
                            name: window.localizedStrings.incomes,
                            color: "blue",
                            type: "bar",
                            data: Array.from(incomeGroups).map((group) => ({
                                value: currencyData.reduce(
                                    (sum, stat) => Number((sum + parseMoneyString(stat.Income[group]?.Total || "0")).toFixed(2)),
                                    0
                                ),
                                name: group,
                            })),
                        },
                    ],
                };
                const totalIncomeEl = document.getElementById("totalIncome");
                totalIncomeEl.style.height = chartHeight + "px";
                totalIncome.setOption(totalIncomeOption);
                totalIncome.resize();
                const reversedLabels = labels.slice().reverse();
                const monthlyExpenses = echarts.init(document.getElementById("monthlyExpenses"));
                const monthlyExpensesOption = {
                    title: { text: window.localizedStrings.monthlyExpensesPerCategory, left: "center", top: "10px" },
                    tooltip: {
                        trigger: "item",
                        axisPointer: { type: "shadow" },
                        formatter: function (params) {
                            let result = `${params.data.monthLabel}<br>`;
                            if (params.value > 0) {
                                result += `${params.marker} ${params.seriesName}: ${params.value.toFixed(2)}% (${formatCurrency(params.data.monetaryValue)} ${currentCurrency})<br>`;
                            }
                            return result;
                        }
                    },
                    legend: { type: "scroll", orient: "horizontal", top: "40px", left: "center", right: "10%" },
                    toolbox: { feature: {
                        saveAsImage: {show: true, pixelRatio: 2, title: "Save as x2 image"},
                        myLabelSwitcher: {
                            show: true,
                            title: "Toggle labels on categories",
                            icon: "path://M4 4h16v2H4V4zm0 6h16v2H4v-2zm0 6h16v2H4v-2z",
                            onclick: function () {
                                var opt = monthlyExpenses.getOption();
                                var current = false;
                                if (opt.series && opt.series.length > 0 && opt.series[0].label && typeof opt.series[0].label[0] !== 'undefined') {
                                    current = !!opt.series[0].label[0].show;
                                } else if (opt.series && opt.series.length > 0 && opt.series[0].label) {
                                    current = !!opt.series[0].label.show;
                                }
                                var next = !current;
                                var newSeries = (opt.series || []).map(function (s) {
                                    var lbl = s.label && (s.label[0] || s.label) ? (s.label[0] || s.label) : {};
                                    lbl.show = next;
                                    return { label: lbl };
                                });
                                monthlyExpenses.setOption({ series: newSeries }, false);
                            }
                        },
                        dataView: {
                            show: true,
                            readOnly: true,
                            optionToContent: function(opt) {
                                var cats = Array.from(expenseGroups);
                                var header = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;border:1px solid #ccc;padding:6px;white-space:nowrap;text-align:left;">Month</th>';
                                for (var c = 0; c < cats.length; c++) {
                                    header += '<th style="border:1px solid #ccc;padding:6px;white-space:nowrap;text-align:right;">' + cats[c] + '</th>';
                                }
                                header += '</tr>';
                                var body = '';
                                for (var i = 0; i < labels.length; i++) {
                                    var monthLabel = labels[i];
                                    var monthData = currencyData[i];
                                    var totals = monthData.Expense;
                                    var monthTotal = 0;
                                    Object.keys(totals).forEach(function(key){ monthTotal += parseMoneyString(totals[key].Total); });
                                    var row = '<tr><td style="position:sticky;left:0;background:#fff;z-index:1;border:1px solid #ccc;padding:6px;white-space:nowrap;text-align:left;">' + monthLabel + '</td>';
                                    for (var j = 0; j < cats.length; j++) {
                                        var g = cats[j];
                                        var groupValue = totals[g] ? parseMoneyString(totals[g].Total) : 0;
                                        var percent = monthTotal ? (groupValue / monthTotal * 100).toFixed(2) : '0.00';
                                        var cell = percent + '% (' + formatCurrency(groupValue.toFixed(2)) + ')';
                                        row += '<td style="border:1px solid #ccc;padding:6px;text-align:right;white-space:nowrap;">' + cell + '</td>';
                                    }
                                    row += '</tr>';
                                    body += row;
                                }
                                var table = '<div style="overflow:auto;"><table style="border-collapse:collapse;width:100%;text-align:left"><thead>' + header + '</thead><tbody>' + body + '</tbody></table></div>';
                                return table;
                            }
                        }
                    } },
                    grid: { left: "3%", right: "5%", bottom: "5%", top: "100px", containLabel: true },
                    xAxis: { type: "value", name: window.localizedStrings.percentage, nameLocation: "middle", nameGap: 30, max: 100, axisLabel: { formatter: "{value}%" } },
                    yAxis: { type: "category", data: reversedLabels, axisLabel: { interval: 0, rotate: 0 }, axisTick: { alignWithLabel: true } },
                    series: Array.from(expenseGroups).map((category) => ({
                        name: category,
                        type: "bar",
                        label: {
                            show: true,
                            minMargin: 20,
                            distance: 50,
                            formatter: function (params) {
                                if (params.value === 0) return "";
                                return formatCurrency(parseMoneyString(params.data.monetaryValue.toFixed(2)));
                            }
                        },
                        overflow: "breakAll",
                        stack: "total",
                        emphasis: { focus: "series" },
                        barCategoryGap: "30%",
                        data: currencyData
                            .map((stat, index) => {
                                let monthLabel = labels[index];
                                let monthTotal = Object.values(stat.Expense).reduce((sum, expense) => sum + parseMoneyString(expense.Total), 0);
                                let groupValue = parseMoneyString(stat.Expense[category]?.Total || "0");
                                return {
                                    monthLabel: monthLabel,
                                    category: category,
                                    monetaryValue: groupValue,
                                    value: (groupValue / monthTotal) * 100,
                                };
                            })
                            .reverse(),
                    })),
                };
                function addChartClickHandler(chart, type) {
                    chart.on("click", function (params) {
                        if (params.seriesName && params.name) {
                            const month = params.name;
                            const group = params.seriesName;
                            window.location.href = `/transactions?month=${month}&group=${encodeURIComponent(group)}&type=${type}&currency=${currentCurrency}`;
                        }
                    });
                }
                monthlyExpenses.setOption(monthlyExpensesOption);
                addChartClickHandler(monthlyExpenses, "expense");
                const monthlyIncome = echarts.init(document.getElementById("monthlyIncome"));
                const monthlyIncomeOption = {
                    title: { text: window.localizedStrings.monthlyIncomePerCategory, left: "center", top: "10px" },
                    tooltip: {
                        trigger: "item",
                        axisPointer: { type: "shadow" },
                        formatter: function (params) {
                            let result = `${params.data.monthLabel}<br>`;
                            if (params.value > 0) {
                                result += `${params.marker} ${params.seriesName}: ${params.value.toFixed(2)}% (${formatCurrency(params.data.monetaryValue)} ${currentCurrency})<br>`;
                            }
                            return result;
                        }
                    },
                    legend: { type: "scroll", orient: "horizontal", top: "40px", left: "center", right: "10%" },
                    toolbox: { feature: {
                        saveAsImage: {show: true, pixelRatio: 2, title: "Save as x2 image"},
                        myLabelSwitcher: {
                            show: true,
                            title: "Toggle labels on categories",
                            icon: "path://M4 4h16v2H4V4zm0 6h16v2H4v-2zm0 6h16v2H4v-2z",
                            onclick: function () {
                                var opt = monthlyIncome.getOption();
                                var current = false;
                                if (opt.series && opt.series.length > 0 && opt.series[0].label && typeof opt.series[0].label[0] !== 'undefined') {
                                    current = !!opt.series[0].label[0].show;
                                } else if (opt.series && opt.series.length > 0 && opt.series[0].label) {
                                    current = !!opt.series[0].label.show;
                                }
                                var next = !current;
                                var newSeries = (opt.series || []).map(function (s) {
                                    var lbl = s.label && (s.label[0] || s.label) ? (s.label[0] || s.label) : {};
                                    lbl.show = next;
                                    return { label: lbl };
                                });
                                monthlyIncome.setOption({ series: newSeries }, false);
                            }
                        },
                        dataView: {
                            show: true,
                            readOnly: true,
                            optionToContent: function(opt) {
                                var cats = Array.from(incomeGroups);
                                var header = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;border:1px solid #ccc;padding:6px;white-space:nowrap;text-align:left;">Month</th>';
                                for (var c = 0; c < cats.length; c++) {
                                    header += '<th style="border:1px solid #ccc;padding:6px;white-space:nowrap;text-align:right;">' + cats[c] + '</th>';
                                }
                                header += '</tr>';
                                var body = '';
                                for (var i = 0; i < labels.length; i++) {
                                    var monthLabel = labels[i];
                                    var monthData = currencyData[i];
                                    var totals = monthData.Income;
                                    var monthTotal = 0;
                                    Object.keys(totals).forEach(function(key){ monthTotal += parseMoneyString(totals[key].Total); });
                                    var row = '<tr><td style="position:sticky;left:0;background:#fff;z-index:1;border:1px solid #ccc;padding:6px;white-space:nowrap;text-align:left;">' + monthLabel + '</td>';
                                    for (var j = 0; j < cats.length; j++) {
                                        var g = cats[j];
                                        var groupValue = totals[g] ? parseMoneyString(totals[g].Total) : 0;
                                        var percent = monthTotal ? (groupValue / monthTotal * 100).toFixed(2) : '0.00';
                                        var cell = percent + '% (' + formatCurrency(groupValue.toFixed(2)) + ')';
                                        row += '<td style="border:1px solid #ccc;padding:6px;text-align:right;white-space:nowrap;">' + cell + '</td>';
                                    }
                                    row += '</tr>';
                                    body += row;
                                }
                                var table = '<div style="overflow:auto;"><table style="border-collapse:collapse;width:100%;text-align:left"><thead>' + header + '</thead><tbody>' + body + '</tbody></table></div>';
                                return table;
                            }
                        }
                        }
                    },
                    grid: { left: "3%", right: "5%", bottom: "5%", top: "100px", containLabel: true },
                    xAxis: { type: "value", name: window.localizedStrings.percentage, nameLocation: "middle", nameGap: 30, max: 100, axisLabel: { formatter: "{value}%" } },
                    yAxis: { type: "category", data: reversedLabels, axisLabel: { interval: 0, rotate: 0 }, axisTick: { alignWithLabel: true } },
                    series: Array.from(incomeGroups).map((category) => ({
                        name: category,
                        type: "bar",
                        label: {
                            show: true,
                            minMargin: 20,
                            distance: 50,
                            formatter: function (params) {
                                if (params.value === 0) return "";
                                return formatCurrency(parseMoneyString(params.data.monetaryValue.toFixed(2)));
                            }
                        },
                        overflow: "breakAll",
                        stack: "total",
                        emphasis: { focus: "series" },
                        barCategoryGap: "30%",
                        data: currencyData
                            .map((stat, index) => {
                                let monthLabel = labels[index];
                                let monthTotal = Object.values(stat.Income).reduce((sum, income) => sum + parseMoneyString(income.Total), 0);
                                let groupValue = parseMoneyString(stat.Income[category]?.Total || "0");
                                return {
                                    monthLabel: monthLabel,
                                    category: category,
                                    monetaryValue: groupValue,
                                    value: monthTotal ? (groupValue / monthTotal) * 100 : 0,
                                };
                            })
                            .reverse(),
                    })),
                };
                monthlyIncome.setOption(monthlyIncomeOption);
                addChartClickHandler(monthlyIncome, "income");
                window.addEventListener("resize", function () {
                    expensesVsIncome.resize();
                    totalExpenses.resize();
                    totalIncome.resize();
                    monthlyExpenses.resize();
                    monthlyIncome.resize();
                });
            }
            updateCharts(currentCurrency);
            currencySelector.addEventListener("change", function (e) {
                currentCurrency = e.target.value;
                updateCharts(currentCurrency);
            });
            if (timelineSelector) {
                if (!timelineSelector.value) timelineSelector.value = "12";
                timelineSelector.addEventListener("change", function (e) {
                    updateCharts(currentCurrency);
                });
            }
        });
    </script>
</body>
</html>
